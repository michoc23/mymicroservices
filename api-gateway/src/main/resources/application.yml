server:
  port: 8080

spring:
  application:
    name: api-gateway
  
  cloud:
    gateway:
      routes:
        # User Service Routes
        - id: user-service-auth
          uri: http://user-service:8081
          predicates:
            - Path=/api/v1/auth/**
          filters:
            - StripPrefix=2

        - id: user-service-users
          uri: http://user-service:8081
          predicates:
            - Path=/api/v1/users/**
          filters:
            - StripPrefix=2

        # Ticket Service Routes
        - id: ticket-service
          uri: http://ticket-service:8083
          predicates:
            - Path=/api/v1/tickets/**
          filters:
            - StripPrefix=2

        # Subscription Service Routes
        - id: subscription-service
          uri: http://subscription-service:8084
          predicates:
            - Path=/api/v1/subscriptions/**
          filters:
            - StripPrefix=2

        # Route Service Routes
        - id: route-service-routes
          uri: http://route-service:8085
          predicates:
            - Path=/api/v1/routes/**
          filters:
            - StripPrefix=0

        - id: route-service-stops
          uri: http://route-service:8085
          predicates:
            - Path=/api/v1/stops/**
          filters:
            - StripPrefix=0

        - id: route-service-departures
          uri: http://route-service:8085
          predicates:
            - Path=/api/v1/departures/**
          filters:
            - StripPrefix=0

        - id: route-service-paths
          uri: http://route-service:8085
          predicates:
            - Path=/api/v1/paths/**
          filters:
            - StripPrefix=0

        # Bus Geolocation Service Routes
        - id: geolocation-service-buses
          uri: http://bus-geolocation-service:8086
          predicates:
            - Path=/api/v1/buses/**
          filters:
            - StripPrefix=0

        - id: geolocation-service-locations
          uri: http://bus-geolocation-service:8086
          predicates:
            - Path=/api/v1/locations/**
          filters:
            - StripPrefix=0

        - id: geolocation-service-alerts
          uri: http://bus-geolocation-service:8086
          predicates:
            - Path=/api/v1/alerts/**
          filters:
            - StripPrefix=0

        # WebSocket for Bus Geolocation
        - id: geolocation-websocket
          uri: ws://bus-geolocation-service:8086
          predicates:
            - Path=/api/v1/ws/**
          filters:
            - StripPrefix=0

      globalcors:
        cors-configurations:
          '[/**]':
            allowedOriginPatterns: "*"
            allowedMethods:
              - GET
              - POST
              - PUT
              - DELETE
              - OPTIONS
            allowedHeaders: "*"
            allowCredentials: true
            maxAge: 3600

      default-filters:
        - DedupeResponseHeader=Access-Control-Allow-Credentials Access-Control-Allow-Origin

  # Redis for rate limiting
  data:
    redis:
      host: ${SPRING_REDIS_HOST:redis}
      port: ${SPRING_REDIS_PORT:6379}
      timeout: 2000ms

# Logging
logging:
  level:
    root: INFO
    org.springframework.cloud.gateway: DEBUG
    org.springframework.web: DEBUG
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss} - %msg%n"

# Actuator
management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,prometheus,gateway
  endpoint:
    health:
      show-details: always
    gateway:
      enabled: true
